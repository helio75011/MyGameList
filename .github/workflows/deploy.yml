name: ğŸš€ Deploy Frontend (Vite) and Backend (Node.js) to VPS

on:
  push:
    branches: [main]

jobs:
  # ============================
  # ğŸ—ï¸ Ã‰tape 1 : Build du Frontend Vite
  # ============================
  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: âš™ï¸ Installer Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: ğŸ“¦ Installer les dÃ©pendances du frontend
        run: |
          cd admin-dashboard
          npm ci

      - name: ğŸ—ï¸ Build du frontend avec Vite
        env:
            TSC_COMPILE_ON_ERROR: true
        run: |
          cd admin-dashboard
          npm run build

      - name: ğŸ“¤ Sauvegarder le build comme artefact temporaire
        uses: actions/upload-artifact@v4
        with:
          name: vite-build
          path: frontend/dist

  # ============================
  # ğŸš€ Ã‰tape 2 : DÃ©ploiement du Frontend sur le VPS
  # ============================
  deploy-frontend:
    needs: build-frontend
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ğŸ“¥ TÃ©lÃ©charger l'artefact du build
        uses: actions/download-artifact@v4
        with:
          name: vite-build
          path: dist

      - name: ğŸ” PrÃ©parer la clÃ© SSH
        run: |
          echo "${{ secrets.VPS_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      - name: ğŸ“¦ DÃ©ployer le frontend via rsync
        run: |
          rsync -avz -e "ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no" \
          dist/ \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH_FRONT }}

      - name: ğŸ” Relancer le service frontend avec PM2
        run: |
          ssh -i /tmp/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
          "pm2 reload frontend || pm2 start 'npx serve -s ${{ secrets.VPS_PATH_FRONT }}' --name frontend"

  # ============================
  # âš™ï¸ Ã‰tape 3 : DÃ©ploiement du Backend sur le VPS
  # ============================
  deploy-backend:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§­ Checkout du dÃ©pÃ´t
        uses: actions/checkout@v3

      - name: ğŸ” PrÃ©parer la clÃ© SSH
        run: |
          echo "${{ secrets.VPS_KEY }}" > /tmp/deploy_key
          chmod 600 /tmp/deploy_key

      - name: ğŸ“¦ DÃ©ployer le backend via rsync
        run: |
          rsync -avz -e "ssh -i /tmp/deploy_key -o StrictHostKeyChecking=no" \
          backend/ \
          ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.VPS_PATH_BACK }}

      - name: ğŸ” Installer dÃ©pendances & redÃ©marrer le backend via PM2
        run: |
          ssh -i /tmp/deploy_key ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd ${{ secrets.VPS_PATH_BACK }}
            npm ci --omit=dev
            pm2 reload backend || pm2 start index.js --name backend
          EOF
